---
title: 'Metamorphic Malware'
date: 2024-07-11T17:31:56+02:00

footer: 'Jakob Friedl Â© 2024' 

categories: ['malware-development']

blog_post: true
---

<!--
Resources:
- https://vxug.fakedoma.in/archive/VxHeaven/lib/vmd01.html 
- https://erkinekici.com/articles/metamorphic-literature/ 
- https://erkinekici.com/articles/metamorphic-engines/
- https://selfevolvingcode.blogspot.com/
- http://virus.wikidot.com/metaphor 
- https://onlinelibrary.wiley.com/doi/10.1155/2023/8227751 
- https://www.informit.com/articles/article.aspx?p=366890&seqNum=6 
- https://z0mbie.dreamhosters.com/metamorf.txt
- https://github.com/REMath/literature_review/blob/master/README.md#binary-rewriting 
- https://harrisonwl.github.io/assets/courses/malware/spring2017/papers/HuntingMetamorphic.pdf 
- https://ieeexplore.ieee.org/document/10431609
- https://inria.hal.science/inria-00338066/document
- https://dev.to/khairuaqsara/understanding-metamorphic-code-3g7
-->

Metamorphic or self-modifying code is an advanced technique used by virus and malware authors which enables their malicious program to rewrite itself in a way that the code remains functionally equivalent but looks different each time it is executed. This characteristic prevents antivirus software from detecting the malware using static signatures and makes reverse engineering more difficult.

<!--more-->

This article will provide an overview of metamorphic malware, the difference to polymorphic malware and how it can be implemented, by taking a look at how *The Mental Driller* from the 29A virus group structures metamorphic engines[^1]. 

## Metamorphism vs Polymorphism

The term polymorphism in regard to malware or virus development has little to do with it's use in object-oriented programming. Instead, polymorphic malware can change its signature by generating and using a mutation engine that generates a new decryption routine for each generation of the virus. After the initial virus body is decrypted, the decryption routine is mutated and the virus body as well as the decryptor are encrypted again, before being linked together for the next iteration[^2]. The downside of this approach is obvious: the decrypted virus body does not change and can therefore be detected and flagged by antivirus software, which is the reason why metamorphic engines came into existence.

Metamorphism can be defined as *body-polymorphism*[^3]. Instead of having a constant virus body, a metamorphic engine is able to create new generations of the virus which are functionally equivalent but look different for every new infection. It's not just the decryptor that mutates, but everything else in the code as well. This can be achieved by using three mutation techniques: 

- **Compression**: The virus body is compressed by combining multiple assembly instructions into one that does the same thing. This step is necessary to avoid the malware from growing too large in size.
- **Permutation**: Intstructions are permuted by changing the order or by replacing them with equivalent instructions.
- **Expansion**:  Instructions are rewritten into multiple instructions that do the same thing and insert dead code that adds not functionality. This technique is only used if compression is present, since the virus code would grow uncontrollably otherwise. 

While the permutation aspect is usually present in most metamorphic engines, the others are used to a lesser extent, due to the difficulty of implementing the compression code. According to The Mental Driller, the *Accordion* model (compression & expansion) in combination with permutation generates *absolute metamorphism*, which means that code skeleton changes but not the algorithm[^1].  

## The Metamorphic Engine

The metamorphic engine is the core part of a metamorphic virus that is responsible for the mutation of the virus body. It takes of more than 90% percent of the virus code, with the remaining part being the infector itself. The structure of the engine was described by The Mental Driller in 2002 but can still be applied to modern metamorphic malware. It incorporates the mutation techniques mentioned above in the shrinker, permutator and expander components and further includes a disassembler and assembler.  

![Structure of metamorphic code](/img/metamorphic_malware/metamorphic-engine-dark.png#dark)
![Structure of metamorphic code](/img/metamorphic_malware/metamorphic-engine-light.png#light)

The following sections will provide a brief overview of each component of the engine. In particular, this article will focus on *MetaPHOR*[^4] (metamorphic permutating high-obfuscating reassembler), also known as *W32/Simile*[^5] by The Mental Driller. The replication mechanism of the virus is out of scope for this blog post but can be read about [here](https://www.informit.com/articles/article.aspx?p=366890&seqNum=6).

{{< color-block style="info">}}
**To be continued**
{{< /color-block>}}

{{< color-block style="alert">}}
**To be continued**
{{< /color-block>}}
{{< color-block style="warning">}}
**To be continued**
{{< /color-block>}}
{{< color-block style="note">}}
**To be continued**
{{< /color-block>}}
{{< color-block style="success">}}
**To be continued**
{{< /color-block>}}

### Disassembler



### Shrinker 



### Permutator



### Expander



### Assembler



## Conclusion

[^1]: Metamorphism in practice or "How I made MetaPHOR and what I've learnt", https://vxug.fakedoma.in/archive/VxHeaven/lib/vmd01.html
[^2]: Metamorphic Malware and Obfuscation: A Survey of Techniques, Variants, and Generation Kits, https://onlinelibrary.wiley.com/doi/10.1155/2023/8227751
[^3]: Advanced Code Evolution Techniques and Computer Virus Generator Kits: https://www.informit.com/articles/article.aspx?p=366890&seqNum=6
[^4]: MetaPHOR source code: https://github.com/mal-project/win32.MetaPHOR
[^5]: https://en.wikipedia.org/wiki/Simile_(computer_virus)